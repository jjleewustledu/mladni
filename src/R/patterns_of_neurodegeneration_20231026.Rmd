---
title: "Patterns of Neurodegeneration 20231026"
author: "J. J. Lee"
date: "2023 Oct 26"
output:
  html_document:
    keep_md: yes
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*.

```{r start-up test}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r setup-chunk, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	cache = TRUE,
	dev = c("png", "tiff"),
	dpi = 1200
)
```

```{r import libraries}
library(readr)
library(tibble)
library(dplyr) # provides filter
library(mgcv)
library(ggplot2)
library(scales)
library(viridis)
library(reshape2)
library(corrplot)
library(voxel)
library(ppcor)
library(stats)
library(pracma) # Matlab emulations
library(lubridate) # char -> date object
library(mgcViz)
library(gamm4)
```


Read previously concentrated data, originating from ADNIMerge, my Matlab package mladni, and data located at 
  login3.chpc.wustl.edu:/scratch/jjlee/Singularity/ADNI/NMF_FDG.

```{r}
setwd("/Volumes/PrecunealSSD/Singularity/ADNI/NMF_FDG")
getwd()
tib_covariates <- read_csv("baseline_cn/NumBases24/components/NMFCovariates_table_covariates_1stscan_longitudinal.csv")
tib_covariates
```


Following examples from <https://rdrr.io/cran/mgcv/man/mvn.html> and <https://cnuge.github.io/post/multi_variable/>.
AcqDuration ~ years.

```{r split_components function}
split_components <- function(tib_in) {
  components <- dplyr::select(tib_in, Components_1:Components_24)
  Y_ <- as.matrix(components)
  y0 <- Y_[,1]
  y1 <- Y_[,2]
  y2 <- Y_[,3]
  y3 <- Y_[,4]
  y4 <- Y_[,5]
  y5 <- Y_[,6]
  y6 <- Y_[,7]
  y7 <- Y_[,8]
  y8 <- Y_[,9]
  y9 <- Y_[,10]
  y10 <- Y_[,11]
  y11 <- Y_[,12]
  y12 <- Y_[,13]
  y13 <- Y_[,14]
  y14 <- Y_[,15]
  y15 <- Y_[,16]
  y16 <- Y_[,17]
  y17 <- Y_[,18]
  y18 <- Y_[,19]
  y19 <- Y_[,20]
  y20 <- Y_[,21]
  y21 <- Y_[,22]
  y22 <- Y_[,23]
  y23 <- Y_[,24]
  age <- tib_in$Age
  sex <- tib_in$Sex
  apoe4 <- tib_in$ApoE4
  cohort <- tib_in$Cohort
  subject <- tib_in$Subject
  acqduration <- tib_in$AcqDuration
  tib_out_ <- tibble(y0, y1, y2, y3, y4, y5, y6, y7, y8, y9, y10, y11, y12, y13, y14, y15, y16, y17, y18, y19, y20, y21, y22, y23, age, sex, apoe4, cohort, subject, acqduration)
  tib_out_$sex <- relevel(factor(tib_out_$sex), ref="F")
  tib_out_$apoe4 <- relevel(factor(tib_out_$apoe4), ref="0")
  tib_out_$subject <- factor(tib_out_$subject)
  return(list(tib_out=tib_out_, Y=Y_))
}
```


Invoke split_components.  
  Invoke split_components for subtable with Cohort=="CDR=0,amy-", etc., and AcqDuration==0 for cross-sectional analyses,
  following <https://stackoverflow.com/questions/29540658/r-how-to-make-a-subtable>.

```{r invoke split_components, dev=c("png", "tiff")}
split_out <- split_components(tib_covariates)
split_out$tib_out$cohort <- relevel(factor(split_out$tib_out$cohort), ref="CDR=0,amy-")
summary(split_out$tib_out) # for gam

split_out_cn <- split_components(filter(tib_covariates, Cohort=="CDR=0,amy-" & AcqDuration==0))
summary(split_out_cn$tib_out) # for gam

split_out_pc <- split_components(filter(tib_covariates, Cohort=="CDR=0,amy+" & AcqDuration==0))
summary(split_out_pc$tib_out) # for gam

split_out_mci <- split_components(filter(tib_covariates, Cohort=="CDR=0.5,amy+" & AcqDuration==0))
summary(split_out_mci$tib_out) # for gam

split_out_ad <- split_components(filter(tib_covariates, Cohort=="CDR>0.5,amy+" & AcqDuration==0))
summary(split_out_ad$tib_out) # for gam

split_out_dem <- split_components(filter(tib_covariates, Cohort=="CDR>0.5,amy-" & AcqDuration==0))
summary(split_out_ad$tib_out) # for gam
```


Form y* and Y for cross-sectional or longitudinal analyses.
soto is a sub-tibble generated by function split_components().

```{r y-star and Y, dev=c("png", "tiff")}

soto <- split_out$tib_out
y0 <- soto$y0
y1 <- soto$y1
y2 <- soto$y2
y3 <- soto$y3
y4 <- soto$y4
y5 <- soto$y5
y6 <- soto$y6
y7 <- soto$y7
y8 <- soto$y8
y9 <- soto$y9
y10 <- soto$y10
y11 <- soto$y11
y12 <- soto$y12
y13 <- soto$y13
y14 <- soto$y14
y15 <- soto$y15
y16 <- soto$y16
y17 <- soto$y17
y18 <- soto$y18
y19 <- soto$y19
y20 <- soto$y20
y21 <- soto$y21
y22 <- soto$y22
y23 <- soto$y23
age <- soto$age
sex <- soto$sex
apoe4 <- soto$apoe4
cohort <- soto$cohort
subject <- soto$subject
acqduration <- soto$acqduration
Y <- split_out$Y
```


Number of thin-plate spline knots needs a degree
of freedom for model intercept, a constant basis always required.
See also <https://stats.stackexchange.com/questions/359568/choosing-k-in-mgcvs-gam>.

```{r number of spline knots, dev=("png", "tiff")}
K<-21
```
  

Multivariate GAMs, no interactions

```{r dev=c("png", "tiff")}
b1 <- gam(list(
y0~s(age,k=K)+sex+apoe4+cohort, y1~s(age,k=K)+sex+apoe4+cohort, y2~s(age,k=K)+sex+apoe4+cohort, 
y3~s(age,k=K)+sex+apoe4+cohort, y4~s(age,k=K)+sex+apoe4+cohort, y5~s(age,k=K)+sex+apoe4+cohort, 
y6~s(age,k=K)+sex+apoe4+cohort, y7~s(age,k=K)+sex+apoe4+cohort, y8~s(age,k=K)+sex+apoe4+cohort, 
y9~s(age,k=K)+sex+apoe4+cohort, y10~s(age,k=K)+sex+apoe4+cohort, y11~s(age,k=K)+sex+apoe4+cohort, 
y12~s(age,k=K)+sex+apoe4+cohort, y13~s(age,k=K)+sex+apoe4+cohort, y14~s(age,k=K)+sex+apoe4+cohort, 
y15~s(age,k=K)+sex+apoe4+cohort, y16~s(age,k=K)+sex+apoe4+cohort, y17~s(age,k=K)+sex+apoe4+cohort, 
y18~s(age,k=K)+sex+apoe4+cohort, y19~s(age,k=K)+sex+apoe4+cohort, y20~s(age,k=K)+sex+apoe4+cohort, 
y21~s(age,k=K)+sex+apoe4+cohort, y22~s(age,k=K)+sex+apoe4+cohort, y23~s(age,k=K)+sex+apoe4+cohort), 
family=mvn(d=24), data=soto)
b1
summary(b1)
```


Multivariate GAMs, with interactions.

```{r dev=c("png", "tiff")}
b2 <- gam(list(
y0~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y1~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y2~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y3~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y4~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y5~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y6~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y7~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y8~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y9~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y10~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y11~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y12~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y13~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y14~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y15~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y16~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y17~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y18~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y19~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y20~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, 
y21~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y22~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort, y23~s(age,k=K,by=interaction(sex))+sex+apoe4+cohort), 
family=mvn(d=24), data=soto)
b2
summary(b2)
```


```{r plot; AIC; BIC; gam.check, echo=TRUE, dev=c("png", "tiff")}
#adjust plot margins
par(mar = c(1, 1, 1, 1))
plot(b2, page=1)
#covariance <- solve(crossprod(b$family$data$R))
AIC(b2, k=2)
BIC(b2)
gam.check(b2)
save(b2, file="b2.Rdata")
saveRDS(b2, file="b2.Rds")
```


Cross-sectional data, set by chunk "Form y* and Y"
  Analog of Fig. 2D, Nazeri et al. Neuron 2022. {Age -\> Component_i}\_i
  CN, preclinical, MCI, AD

```{r cross-sectional Nazeri fig2, dev=c("png", "tiff")}
Y_cohort <- split_out_dem$Y
soto_cohort <- split_out_dem$tib_out
age_cohort <- soto_cohort$age
sex_cohort <- soto_cohort$sex
apoe4_cohort <- soto_cohort$apoe4
cohort_str <- "CDR>0.5,amy-"

for (idx in 1:24) {

  # gather variables
  y_i <- Y_cohort[,idx]
  tib_y_i <- tibble(y_i, age_cohort, sex_cohort, apoe4_cohort)
  #summary(tib_y_i)
  
  # build gam, univariate
  b_i <- gam(y_i ~ s(age_cohort, k=K, by=interaction(sex_cohort)) + sex_cohort + apoe4_cohort, data=tib_y_i, method="REML") #
  #summary(b_i)
  #AIC(b_i, k=2)
  #BIC(b_i)
  gam.check(b_i)
  
  # ggplot2
  df <- data.frame(age_cohort = age_cohort, y_i = y_i, sex_cohort = sex_cohort)
  ndf <- expand.grid(age_cohort = seq(min(tib_y_i$age_cohort), max(tib_y_i$age_cohort), length.out=480), sex_cohort = unique(tib_y_i$sex_cohort), apoe4_cohort = unique(tib_y_i$apoe4_cohort))
  ndf$FDG <- predict(b_i, newdata = ndf, type = "response")

  o <- ggplot(ndf, aes(x = age_cohort, y = FDG, col = sex_cohort)) +
    geom_line(linewidth = 2) +
    geom_point(data = df, aes(y = y_i), size = 4, alpha = 0.3) +
    geom_rug(mapping = aes(y = FDG), alpha = 0.3) + 
    labs(x = NULL, y = NULL, title = sprintf("ADNI P%i", idx)) + 
    theme_classic(base_size = 18) +
    theme(axis.text.x=element_text(size=18), 
          axis.text.y=element_text(size=18), 
          legend.text=element_text(size=14),
          legend.title=element_text(size=14))
  if (idx < 24) {
    o <- o + theme(legend.position = "none")
  }
  print(o)
  
  # mgcViz
  #viz <- getViz(b_i)
  #o <- plot(sm(viz,1))
  #print(o + l_fitLine(colour = "#f1605d") + l_rug(mapping = aes(x=x, y=y), alpha = 0.3) +
  #  l_ciLine(mul = 5, colour = "#721f81", linetype = 2) + 
  #  l_points(shape = 19, size = 1, alpha = 0.2) + labs(title=sprintf("ADNI P%i (SUVR)", idx)) + theme_classic())
  
  ggsave(sprintf("Pattern %i vs Age (%s).png", idx, cohort_str), width=2.5, height=1.56, units="in", scale=3, dpi=800)
  
  # see also https://stackoverflow.com/questions/35618260/remove-legend-ggplot-2-2 
  # see also https://waldyrious.net/viridis-palette-generator/
}
```


Mixed models for longitudinal data, set by chunk "Form y* and Y"
  Analog of Fig. 2D, Nazeri et al. Neuron 2022. {Age -\> Component_i}\_i

```{r longitudinal Nazeri fig2, dev=c("png", "tiff")}
for (idx in 1:1) {

  # gather variables
  y_i <- Y[,idx]
  tib_y_i <- tibble(y_i, age, sex, apoe4)
  #summary(tib_y_i)
  
  # build gamm4, univariate
  b_i <- gamm4(y_i~s(age,by=interaction(sex)) + sex + apoe4, random=NULL, data=tib_y_i) 
  # https://www.sciencedirect.com/science/article/pii/S1053811920310818#sec0016
  # https://stats.stackexchange.com/questions/344195/model-comparison-of-gams-using-gamm4
  # https://stats.stackexchange.com/questions/565460/is-my-gam-modeling-longitudinal-change-appropriately
  # https://www.nature.com/articles/s41380-019-0360-1#Sec2
  # https://rdrr.io/cran/gamm4/man/gamm4.html
  #summary(b_i)
  #AIC(b_i, k=2)
  #BIC(b_i)
  #gamm4.check(b_i)
  
  # ggplot2
  df <- data.frame(age = age, y_i = y_i, sex = sex)
  ndf <- expand.grid(age = seq(min(tib_y_i$age), max(tib_y_i$age), length.out=100), sex = unique(tib_y_i$sex))
  ndf$FDG <- predict(b_i, newdata = ndf, type = "response")

  o <- ggplot(ndf, aes(x = age, y = FDG, col = sex)) +
    geom_line(linewidth = 2) +
    geom_point(data = df, aes(y = y_i), size = 4, alpha = 0.3) +
    geom_rug(mapping = aes(y = FDG), alpha = 0.3) + 
    labs(x = NULL, y = NULL, title = sprintf("ADNI P%i", idx)) + 
    theme_classic(base_size = 18) +
    theme(axis.text.x=element_text(size=18), 
          axis.text.y=element_text(size=18), 
          legend.text=element_text(size=14),
          legend.title=element_text(size=14))
  if (idx < 24) {
    o <- o + theme(legend.position = "none")
  }
  print(o)
  
  # mgcViz
  #viz <- getViz(b_i)
  #o <- plot(sm(viz,1))
  #print(o + l_fitLine(colour = "#f1605d") + l_rug(mapping = aes(x=x, y=y), alpha = 0.3) +
  #  l_ciLine(mul = 5, colour = "#721f81", linetype = 2) + 
  #  l_points(shape = 19, size = 1, alpha = 0.2) + labs(title=sprintf("ADNI P%i (SUVR)", idx)) + theme_classic())
  
  #ggsave(sprintf("Pattern %i vs Age (CDR=0,amy-).png", idx), width=2.5, height=1.56, units="in", scale=3, dpi=800)
  
  # https://stackoverflow.com/questions/35618260/remove-legend-ggplot-2-2 
  # https://stackoverflow.com/questions/49471300/gam-plots-with-ggplot
  # https://waldyrious.net/viridis-palette-generator/
}
```



```{r}
t <- filter(tib_covariates, Age==80.00)
t
```

Analog of Fig. 1A, Nazeri et al. Neuron 2022. Age -\> Meta-ROI

```{r dev=c("png", "tiff")}
# gather variables
metaroi <- tib_covariates$Metaroi
tib_metaroi <- tibble(metaroi, age, sex, apoe4, cohort)
tib_metaroi$sex <- relevel(factor(tib_metaroi$sex), ref="F")
tib_metaroi$cohort <- relevel(factor(tib_metaroi$cohort), ref="CDR=0,amy-")
tib_metaroi
summary(tib_metaroi)

# build gam
b_metaroi <- gam(metaroi~s(age)+sex+apoe4+cohort, data=tib_metaroi)
b_metaroi
summary(b_metaroi)
plot(b_metaroi, page=1)
AIC(b_metaroi, k=2)
BIC(b_metaroi)
gam.check(b_metaroi)

# ggplot2, no groupCovs
plotGAM(b_metaroi, "age", 
        groupCovs=NULL, orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) 
ggsave("Meta-ROI vs Age (no groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)

```
```{r dev=c("png", "tiff")}
# ggplot2, groupCov
plotGAM(b_metaroi, "age", 
        groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="Cohort",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
ggsave("Meta-ROI vs Age (groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```
```{r dev=c("png", "tiff")}
# gather variables
idx <- 24 # 1, 4, 19, 24
y_i <- Y[,idx]
tib_metaroi <- tibble(y_i, age, sex, apoe4, cohort)
tib_metaroi$sex <- relevel(factor(tib_metaroi$sex), ref="F")
tib_metaroi$cohort <- relevel(factor(tib_metaroi$cohort), ref="CDR=0,amy-")
tib_metaroi
summary(tib_metaroi)

# build gam
b_metaroi <- gam(y_i~s(age)+sex+apoe4+cohort, data=tib_metaroi)
b_metaroi
summary(b_metaroi)
plot(b_metaroi, page=1)
AIC(b_metaroi, k=2)
BIC(b_metaroi)
gam.check(b_metaroi)

# ggplot2, no groupCovs
plotGAM(b_metaroi, "age", 
        groupCovs=NULL, orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) 
ggsave("Meta-ROI vs Age (no groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)

```


```{r dev=c("png", "tiff")}
# ggplot2, groupCov
plotGAM(b_metaroi, "age", 
        groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y=sprintf("ADNI P%i (SUVR)", idx)) +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="Cohort",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
ggsave(sprintf("Pattern %i vs Age (groupCovs).png", idx), 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```



Analog of Fig. 1A, Nazeri et al. Neuron 2022. Age -\> FDG/PonsVermis

```{r dev=c("png", "tiff")}
# gather variables
fdg_pv <- tib_covariates$MergeFdg / tib_covariates$PonsVermis
tib_fdg_pv <- tibble(fdg_pv, age, sex, apoe4, cohort)
tib_fdg_pv$sex <- relevel(factor(tib_fdg_pv$sex), ref="F")
tib_fdg_pv$cohort <- relevel(factor(tib_fdg_pv$cohort), ref="CDR=0,amy-")
tib_fdg_pv
summary(tib_fdg_pv)

# build gam
b_fdg_pv <- gam(fdg_pv~s(age,by=interaction(sex,apoe4))+sex+apoe4+cohort, data=tib_fdg_pv)
b_fdg_pv
summary(b_fdg_pv)
plot(b_fdg_pv, page=1)
AIC(b_fdg_pv, k=2)
BIC(b_fdg_pv)
gam.check(b_fdg_pv)

# ggplot2, no groupCovs
plotGAM(b_fdg_pv, "age", 
        groupCovs=NULL, orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y="FDG (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14))
ggsave("FDG vs Age (no groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```
```{r dev=c("png", "tiff")}
# ggplot2, groupCov
plotGAM(b_fdg_pv, "age", 
        groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Age (y)", y="FDG (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="Cohort",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
ggsave("FDG vs Age (groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```

Analog of Fig. 1B, Nazeri et al. Neuron 2022. Dx -\> FDG/PonsVermis.  See mladni.NMFRegressions2 for boxcharts.

--

Analog of Fig. 2F, Nazeri et al. Neuron 2022.

--

Bases and other signal variations with mean cortical Abeta, identifying good predictors. Cross-sectional must use SUMMARYSUVR_WHOLECEREBNORM.  Longitudinal must use SUMMARYSUVR_COMPOSITE_REFNORM.

```{r dev=c("png", "tiff")}
metaroi <- tib_covariates$Metaroi
amyloid <- tib_covariates$SUMMARYSUVR_COMPOSITE_REFNORM
tib_amy <- tibble(metaroi, amyloid, age, sex, apoe4, cohort)
tib_amy$sex <- relevel(factor(tib_amy$sex), ref="F")
tib_amy$cohort <- relevel(factor(tib_amy$cohort), ref="CDR=0,amy-")
tib_amy
summary(tib_amy)

# build gam
b_amy <- gam(metaroi~s(amyloid)+s(age,by=interaction(sex,apoe4))+sex+apoe4+cohort, data=tib_amy)
b_amy
summary(b_amy)
plot(b_amy, page=1)
AIC(b_amy, k=2)
BIC(b_amy)
gam.check(b_amy)

# ggplot2, no groupCovs
plotGAM(b_amy, "amyloid", 
        groupCovs=NULL, orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Amyloid (SUVR)", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) 
ggsave("Meta-ROI vs Amyloid (no groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```
```{r dev=c("png", "tiff")}
# ggplot2, groupCov
plotGAM(b_amy, "amyloid", 
        groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="Amyloid (SUVR)", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="Cohort",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
ggsave("Meta-ROI vs Amyloid (groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```

```{r dev=c("png", "tiff")}
for (idx in 1:24) {

  # gather variables
  y_i <- Y[,idx]
  tib_y_i <- tibble(y_i, amyloid, age, sex, apoe4, cohort)
  tib_y_i$sex <- relevel(factor(tib_y_i$sex), ref="F")
  tib_y_i$cohort <- relevel(factor(tib_y_i$cohort), ref="CDR=0,amy-")
  tib_y_i
  summary(tib_y_i)
  
  # build gam, univariate
  b_i <- gam(y_i~s(amyloid)+s(age,by=interaction(sex,apoe4))+sex+apoe4+cohort, data=tib_y_i)
  #b_i
  #summary(b_i)
  #plot(b_i, page=1)
  AIC(b_i, k=2)
  BIC(b_i)
  #gam.check(b_i)
  
  # ggplot2, groupCovs+"cohort"
  plotGAM(b_i, "amyloid", 
          groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
    labs(title="", x="", y="") +
    theme(axis.title=element_text(size=18), 
          axis.text.x=element_text(size=18), 
          axis.text.y=element_text(size=18), 
          legend.text=element_text(size=14),
          legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"),  
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
  ggsave(sprintf("Pattern %i vs Amyloid (groupCovs, no labs).png", idx), 
         width=2.5, height=2, units="in", scale=3, dpi=800)
}
```

Bases and other signal variations with CDMEMORY, CDORIENT, CDJUDGE, CDCOMMUN, CDHOME, CDCARE, CDGLOBAL, MergeCdrsb, identifying good predictors. 

```{r dev=c("png", "tiff")}
metaroi <- tib_covariates$Metaroi
cdrsb <- tib_covariates$MergeCdrsb
tib_cdr <- tibble(metaroi, cdrsb, age, sex, apoe4, cohort)
tib_cdr$sex <- relevel(factor(tib_cdr$sex), ref="F")
tib_cdr$cohort <- relevel(factor(tib_cdr$cohort), ref="CDR=0,amy-")
tib_cdr
summary(tib_cdr)

# build gam
b_cdr <- gam(metaroi~s(cdrsb)+s(age,by=interaction(sex,apoe4))+sex+apoe4+cohort, data=tib_cdr)
b_cdr
summary(b_cdr)
plot(b_cdr, page=1)
AIC(b_cdr, k=2)
BIC(b_cdr)
gam.check(b_cdr)

# ggplot2, no groupCovs
plotGAM(b_cdr, "cdrsb", 
        groupCovs=NULL, orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="CDR", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) 
ggsave("Meta-ROI vs CDR (no groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```
```{r dev=c("png", "tiff")}
# ggplot2, groupCov
plotGAM(b_cdr, "cdrsb", 
        groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
  labs(title="", x="CDR", y="Meta-ROI (SUVR)") +
  theme(axis.title=element_text(size=18), 
        axis.text.x=element_text(size=18), 
        axis.text.y=element_text(size=18), 
        legend.text=element_text(size=14),
        legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="Cohort",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
ggsave("Meta-ROI vs CDR (groupCovs).png", 
       width=2.5, height=2, units="in", scale=3, dpi=800)
```

```{r dev=c("png", "tiff")}
for (idx in 1:24) {

  # gather variables
  y_i <- Y[,idx]
  tib_y_i <- tibble(y_i, cdrsb, age, sex, apoe4, cohort)
  tib_y_i$sex <- relevel(factor(tib_y_i$sex), ref="F")
  tib_y_i$cohort <- relevel(factor(tib_y_i$cohort), ref="CDR=0,amy-")
  tib_y_i
  summary(tib_y_i)
  
  # build gam, univariate
  b_i <- gam(y_i~s(cdrsb)+s(age,by=interaction(sex,apoe4))+sex+apoe4+cohort, data=tib_y_i)
  #b_i
  #summary(b_i)
  #plot(b_i, page=1)
  AIC(b_i, k=2)
  BIC(b_i)
  #gam.check(b_i)
  
  # ggplot2, groupCovs+"cohort"
  plotGAM(b_i, "cdrsb", 
          groupCovs="cohort", orderedAsFactor=T, rawOrFitted="raw", plotCI=T) +
    labs(title="", x="", y="") +
    theme(axis.title=element_text(size=18), 
          axis.text.x=element_text(size=18), 
          axis.text.y=element_text(size=18), 
          legend.text=element_text(size=14),
          legend.title=element_text(size=14)) +
  scale_colour_manual(
    name="",
    values=c("#fcfdbf", "#fc8961", "#b73779", "#51127c", "#000004"), 
    breaks=c("CDR=0,amy-", "CDR=0,amy+", "CDR=0.5,amy+", "CDR>0,amy-", "CDR>0.5,amy+"))
  ggsave(sprintf("Pattern %i vs CDR (groupCovs).png", idx), 
         width=2.5, height=2, units="in", scale=3, dpi=800)
}
```